<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ item_info.ovrs_item_name|default('시세 차트') }} - 시세 차트</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@^3"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns/locale/ko/index.js"></script>

    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #0a2342;
            color: #e0e0e0;
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 1000px; 
            margin: auto; 
            background: #1c3d5a;
            padding: 2rem; 
            border-radius: 12px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); 
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4a6a8a;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap; /* 헤더 줄바꿈 허용 */
        }
        h1 { 
            color: white;
            margin: 0;
            font-size: 1.8rem;
        }
        .back-link { 
            text-decoration: none; 
            color: #00aaff;
            background-color: #0a2342;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }
        .back-link:hover {
            background-color: #007bff;
            color: white;
        }
        .price-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 15px;
            text-align: left;
            margin-bottom: 2rem;
            min-height: 60px;
            flex-wrap: wrap;
        }
        .current-price-group .current-price {
            font-size: 2.2rem;
            font-weight: bold;
            color: white;
            margin: 0 0 5px 0;
        }
        .current-price-group .price-change {
            font-size: 1.1rem;
            color: #a0c8e8;
            margin: 0;
        }
        .price-change .profit, .holding-details .profit {
            color: #ef5350; /* 상승: 빨간색 */
        }
        .price-change .loss, .holding-details .loss {
            color: #42a5f5; /* 하락: 파란색 */
        }
        .price-change .even {
            color: #e0e0e0; /* 보합: 흰색 */
        }
        .holding-details {
            text-align: right;
        }
        /* [추가] 모바일 레이아웃을 위한 상세 정보 구조 스타일 */
        .holding-details .detail-group {
            display: flex;
            gap: 20px;
            justify-content: flex-end;
            margin-bottom: 8px;
        }
        .holding-details .detail-item {
            display: flex;
            gap: 8px;
            align-items: baseline;
        }
        .holding-details .label {
            font-weight: normal;
            color: #a0c8e8;
            font-size: 1rem;
        }
        .holding-details .value {
            font-weight: bold;
            color: white;
            font-size: 1rem;
        }
        .holding-details .pl-value {
            margin: 0;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .chart-container {
            position: relative;
            background-color: #0a2342;
            padding: 1rem;
            border-radius: 8px;
            /* [수정] 차트 컨테이너에 비율과 최대 높이 지정 */
            aspect-ratio: 16 / 10;
            max-height: 600px;
            width: 100%;
        }
        .error-message {
            text-align: center;
            padding: 4rem;
            font-size: 1.2rem;
        }

        /* --- [추가] 모바일 반응형 스타일 --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 1rem; }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            h1 { font-size: 1.4rem; }
            .price-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 1.5rem;
            }
            .current-price-group .current-price { font-size: 1.8rem; }
            .holding-details {
                width: 100%;
                text-align: left;
            }
            .holding-details .detail-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .chart-container {
                aspect-ratio: 4 / 3; /* 모바일에서 더 적절한 비율로 조정 */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📈 {{ item_info.ovrs_item_name|default('종목 정보 없음') }} ({{ item_info.ovrs_pdno|default('') }})</h1>
            <a href="{{ url_for('home') }}" class="back-link">돌아가기</a>
        </div>

        {% if item_info and item_info.rt_cd != '1' %}
        <div class="price-info">
            <div class="current-price-group">
                <p class="current-price">${{ "{:,.2f}".format(item_info.clos|default(0)|float) }}</p>
                <p class="price-change">
                    전일 대비
                    <span class="{% if item_info.sign|default('') == '2' %}profit{% elif item_info.sign|default('') == '5' %}loss{% else %}even{% endif %}">
                        {% if item_info.sign|default('') == '2' %}+{% elif item_info.sign|default('') == '5' %}-{% endif %}
                        ${{ "{:,.2f}".format(item_info.diff|default(0)|float) }}
                        ({% if item_info.sign|default('') == '2' %}+{% endif %}{{ "%.2f"|format(item_info.rate|default(0)|float) }}%)
                    </span>
                </p>
            </div>
            
            {% if holding_info %}
            <div class="holding-details">
                <div class="detail-group">
                    <div class="detail-item">
                        <span class="label">평단가</span>
                        <span class="value">${{ "{:,.2f}".format(holding_info.pchs_avg_pric|default(0)|float) }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">보유수량</span>
                        <span class="value">{{ "{:,.0f}".format(holding_info.ovrs_cblc_qty|default(0)|float) }}주</span>
                    </div>
                </div>
                <p class="pl-value {% if (holding_info.frcr_evlu_pfls_amt|default(0)|float) >= 0 %}profit{% else %}loss{% endif %}">
                    ${{ "{:,.2f}".format(holding_info.frcr_evlu_pfls_amt|default(0)|float) }}
                    ({{ "%.2f"|format(holding_info.evlu_pfls_rt|default(0)|float) }}%)
                </p>
            </div>
            {% endif %}
        </div>

        <div class="chart-container">
            <canvas id="stockChart"></canvas>
        </div>
        
        {% else %}
        <div class="error-message">
            <p>종목 정보를 불러올 수 없습니다. ({{ chart_data.msg1 }})</p>
        </div>
        {% endif %}
    </div>

    <script>
    {% if item_info and item_info.rt_cd != '1' %}
    const chartData = JSON.parse('{{ chart_data|safe }}');
    const dailyPrices = chartData.output2 || [];
    Chart.defaults.locale = 'ko';

    const lineData = dailyPrices.map(item => ({
        x: new Date(item.xymd.substring(0, 4) + '-' + item.xymd.substring(4, 6) + '-' + item.xymd.substring(6, 8)).getTime(),
        y: parseFloat(item.clos)
    }));
    
    const volumeData = dailyPrices.map(item => ({
        x: new Date(item.xymd.substring(0, 4) + '-' + item.xymd.substring(4, 6) + '-' + item.xymd.substring(6, 8)).getTime(),
        y: parseFloat(item.tvol)
    }));

    const startPrice = lineData.length > 0 ? lineData[0].y : 0;
    const endPrice = lineData.length > 0 ? lineData[lineData.length - 1].y : 0;
    const trendColor = endPrice >= startPrice ? '#ef5350' : '#42a5f5';

    const ctx = document.getElementById('stockChart').getContext('2d');
    new Chart(ctx, {
        data: {
            datasets: [{
                type: 'line', label: '주가', data: lineData, yAxisID: 'yPrice',
                borderColor: trendColor, borderWidth: 2, pointRadius: 0, tension: 0.1, fill: true,
                backgroundColor: (context) => {
                    const {ctx, chartArea} = context.chart;
                    if (!chartArea) { return null; }
                    const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                    gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
                    const color = endPrice >= startPrice ? '239, 83, 80' : '66, 165, 245';
                    gradient.addColorStop(1, `rgba(${color}, 0.3)`);
                    return gradient;
                },
            }, {
                type: 'bar', label: '거래량', data: volumeData, yAxisID: 'yVolume',
                backgroundColor: 'rgba(110, 137, 161, 0.5)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, /* ✅ [수정] 차트가 컨테이너를 꽉 채우도록 false로 변경 */
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'M월 d일' }},
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: '#e0e0e0', source: 'auto' }
                },
                yPrice: {
                    position: 'left',
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { 
                        color: '#e0e0e0',
                        callback: function(value) { return '$' + value.toLocaleString(); }
                    }
                },
                yVolume: {
                    position: 'right', min: 0,
                    grid: { drawOnChartArea: false },
                    ticks: { 
                        color: '#e0e0e0',
                        callback: function(value) {
                            if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                            if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                            return value;
                        }
                    }
                }
            },
            plugins: {
                legend: { labels: { color: '#e0e0e0' } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed.y !== null) {
                                if (context.dataset.type === 'line') {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                } else {
                                    label += context.parsed.y.toLocaleString();
                                }
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
    </script>
</body>
</html>